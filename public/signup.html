<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Signup - Andhrawala</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3>Sign up</h3>
  <div id="step1">
    <p>Enter your Email or Indian Mobile Number</p>
    <input id="contact" class="form-control mb-3" placeholder="Email or Mobile">
    <button id="sendOtp" class="btn btn-primary">Send OTP</button>
    <div id="msg1" class="mt-3"></div>
  </div>

  <div id="step2" style="display:none;">
    <p>Enter OTP sent to your contact</p>
    <input id="otp" class="form-control mb-3" placeholder="OTP">
    <button id="verifyOtp" class="btn btn-primary">Verify OTP</button>
    <div id="msg2" class="mt-3"></div>
  </div>

  <div id="step3" style="display:none;">
    <p>Fill your Username, Password and Date of Birth</p>
    <input id="username" class="form-control mb-3" placeholder="Username">
    <input id="password" type="password" class="form-control mb-3" placeholder="Password">
    <input id="dob" type="date" class="form-control mb-3" placeholder="Date of Birth">
    <button id="completeSignup" class="btn btn-primary">Complete Signup</button>
    <div id="msg3" class="mt-3"></div>
  </div>
</div>

<script>
  let verifiedContact = null;

  function isValidEmail(email) {
    return /\S+@\S+\.\S+/.test(email);
  }

  function isValidIndianMobile(mobile) {
    return /^[6-9]\d{9}$/.test(mobile);
  }

  document.getElementById('sendOtp').onclick = async () => {
    const contact = document.getElementById('contact').value.trim();
    if (!(isValidEmail(contact) || isValidIndianMobile(contact))) {
      document.getElementById('msg1').innerHTML = '<div class="alert alert-danger">Please enter a valid email or Indian mobile number.</div>';
      return;
    }
    const res = await fetch('/api/send-otp', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({contact})
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('msg1').innerHTML = '<div class="alert alert-success">OTP sent. Please check your contact.</div>';
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
    } else {
      document.getElementById('msg1').innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to send OTP.'}</div>`;
    }
  };

  document.getElementById('verifyOtp').onclick = async () => {
    const otp = document.getElementById('otp').value.trim();
    const contact = document.getElementById('contact').value.trim();
    if (!otp) {
      document.getElementById('msg2').innerHTML = '<div class="alert alert-danger">Please enter the OTP.</div>';
      return;
    }
    const res = await fetch('/api/verify-otp', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({contact, otp})
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('msg2').innerHTML = '<div class="alert alert-success">OTP verified. Please enter your details.</div>';
      verifiedContact = contact;
      document.getElementById('step2').style.display = 'none';
      document.getElementById('step3').style.display = 'block';
    } else {
      document.getElementById('msg2').innerHTML = `<div class="alert alert-danger">${data.error || 'Invalid OTP.'}</div>`;
    }
  };

  document.getElementById('completeSignup').onclick = async () => {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const dob = document.getElementById('dob').value;
    if (!username || !password || !dob) {
      document.getElementById('msg3').innerHTML = '<div class="alert alert-danger">Please fill all fields.</div>';
      return;
    }
    const res = await fetch('/api/signup', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ contact: verifiedContact, username, password, dob })
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('msg3').innerHTML = '<div class="alert alert-success">Account created! <a href="/static/login.html">Login here</a></div>';
      document.getElementById('completeSignup').disabled = true;
    } else {
      document.getElementById('msg3').innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to create account.'}</div>`;
    }
  };
</script>
</body>
</html>

